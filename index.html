<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Meal Planner</title>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4f46e5; --success: #16a34a; --bg-body: #f9fafb; --border: #e5e7eb; }
        body { font-family: sans-serif; background: var(--bg-body); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .day-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .day-chip { display: flex; align-items: center; background: #eee; padding: 8px; border-radius: 6px; cursor: pointer; }
        button { cursor: pointer; border: none; border-radius: 8px; padding: 12px; font-weight: 600; }
        .btn-add { background: var(--primary); color: white; }
        .btn-gen { background: var(--success); color: white; width: 100%; font-size: 1.1rem; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: #f0f4ff; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px; cursor: pointer; opacity: 0.6; }
        .tab.active { opacity: 1; border-bottom: 2px solid var(--primary); font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>My Meal Planner</h1>
        <button class="btn-add" onclick="toggleModal()">Menu / Settings</button>
    </header>

    <div class="card">
        <strong>Non-Veg Allowed Days:</strong>
        <div id="day-selector" class="day-grid" style="margin-top:10px"></div>
    </div>

    <button class="btn-gen" onclick="generatePlan()">Generate Weekly Schedule</button>

    <div class="card" style="padding:0">
        <table>
            <thead><tr><th>Day</th><th>Lunch</th><th>Dinner</th></tr></thead>
            <tbody id="meal-plan-body"></tbody>
        </table>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div class="tabs">
            <div id="t1" class="tab active" onclick="switchTab('add-dish')">Add Dish</div>
            <div id="t2" class="tab" onclick="switchTab('settings')">Settings</div>
        </div>
        <div id="add-dish">
            <div class="form-group"><label>Dish Name</label><input id="d-name" type="text"></div>
            <div class="form-group"><label>Category</label><select id="d-cat"><option>Veg</option><option>Chicken</option><option>Fish</option></select></div>
            <div class="form-group"><label>Servings</label><input id="d-serv" type="number" value="1" min="1"></div>
            <div class="form-group"><label>Daily Dish?</label><select id="d-daily"><option value="false">No</option><option value="true">Yes</option></select></div>
            <div class="form-group"><input type="checkbox" id="d-dup"> <label style="display:inline">Allow Duplicates?</label></div>
            <button class="btn-add" onclick="saveDish()">Save Dish</button>
            <button onclick="toggleModal()">Cancel</button>
        </div>
        <div id="settings" style="display:none">
            <p>Default Veg-Only Days:</p>
            <div id="default-veg-list"></div>
            <button class="btn-add" onclick="saveConfig()" style="margin-top:10px">Save Rules</button>
            <button onclick="toggleModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    const collectionMain = "My Meal Planner";
    const collectionMealPlan = "Current Meal Plan";
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    const firebaseConfig = { 
        apiKey: "AIzaSyBGM_ws-4leOmvLLzIEU62y36cHLjYeezQ",
                authDomain: "my-bookmarks-01.firebaseapp.com",
                projectId: "my-bookmarks-01",
                storageBucket: "my-bookmarks-01.firebasestorage.app",
                messagingSenderId: "202931759065",
                appId: "1:202931759065:web:ccfa3cf456370d839a5bc8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    window.onload = () => {
        const sel = document.getElementById('day-selector');
        const def = document.getElementById('default-veg-list');
        days.forEach(d => {
            sel.innerHTML += `<label class="day-chip"><input type="checkbox" value="${d}" class="nv-check"> ${d}</label>`;
            def.innerHTML += `<div><input type="checkbox" value="${d}" class="def-veg-check"> ${d}</div>`;
        });
        loadPlan();
        loadConfig();
    };

    function toggleModal() { document.getElementById('modal').classList.toggle('active'); }
    function switchTab(t) {
        document.getElementById('add-dish').style.display = t === 'add-dish' ? 'block' : 'none';
        document.getElementById('settings').style.display = t === 'settings' ? 'block' : 'none';
        document.getElementById('t1').classList.toggle('active', t === 'add-dish');
        document.getElementById('t2').classList.toggle('active', t === 'settings');
    }

    async function loadPlan() {
        const snap = await db.collection(collectionMealPlan).get();
        const body = document.getElementById('meal-plan-body');
        body.innerHTML = '';
        const data = {}; snap.forEach(doc => data[doc.id] = doc.data());
        days.forEach(d => {
            const m = data[d] || { lunch: '-', dinner: '-' };
            body.innerHTML += `<tr><td><strong>${d}</strong></td><td>${m.lunch}</td><td>${m.dinner}</td></tr>`;
        });
    }

    async function loadConfig() {
        const doc = await db.collection(collectionMain).doc('config').get();
        if (doc.exists) {
            const veg = doc.data().vegDays || [];
            document.querySelectorAll('.def-veg-check').forEach(c => c.checked = veg.includes(c.value));
        }
    }

    async function saveConfig() {
        const vegDays = Array.from(document.querySelectorAll('.def-veg-check:checked')).map(e => e.value);
        await db.collection(collectionMain).doc('config').set({ vegDays });
        alert("Settings saved!");
    }

    async function saveDish() {
        const name = document.getElementById('d-name').value;
        const category = document.getElementById('d-cat').value;
        const servings = parseInt(document.getElementById('d-serv').value);
        const isDailyDish = document.getElementById('d-daily').value === "true";
        const duplicateEnabled = document.getElementById('d-dup').checked;
        if(!name) return alert("Name required");
        await db.collection(collectionMain).add({ name, category, servings, isDailyDish, duplicateEnabled, type: 'dish', timestamp: Date.now() });
        alert("Dish Saved!");
        toggleModal();
    }

    async function generatePlan() {
        let nvDays = Array.from(document.querySelectorAll('.nv-check:checked')).map(e => e.value);
        if (nvDays.length === 0) {
            const conf = await db.collection(collectionMain).doc('config').get();
            if (conf.exists) {
                const blocked = conf.data().vegDays || [];
                nvDays = days.filter(d => !blocked.includes(d));
            }
        }

        const snap = await db.collection(collectionMain).where('type', '==', 'dish').get();
        let master = []; snap.forEach(d => master.push(d.data()));
        
        let pool = [...master], schedule = {}, leftover = { item: null, rem: 0 };

        for (const day of days) {
            schedule[day] = { lunch: null, dinner: null };
            const isNVDay = nvDays.includes(day);
            const meals = ['lunch', 'dinner'];
            
            // Randomize which slot gets the "Special" dish (Non-Veg or Daily)
            if (Math.random() > 0.5) meals.reverse();

            let nvAssigned = false;
            let dailyAssigned = false;

            for (const m of meals) {
                // Priority 1: Leftovers
                if (leftover.rem > 0) {
                    schedule[day][m] = leftover.item.name;
                    if (leftover.item.category !== 'Veg') nvAssigned = true;
                    if (leftover.item.isDailyDish) dailyAssigned = true;
                    leftover.rem--;
                } 
                else {
                    let picked = null;
                    
                    // Priority 2: Non-Veg Limit (Exactly 1 if possible)
                    if (isNVDay && !nvAssigned) {
                        let options = pool.filter(d => d.category !== 'Veg');
                        if (options.length > 0) {
                            picked = options[Math.floor(Math.random() * options.length)];
                            nvAssigned = true;
                        }
                    } 
                    // Priority 3: Daily Dish on Veg Days
                    else if (!isNVDay && !dailyAssigned) {
                        let options = master.filter(d => d.isDailyDish);
                        if (options.length > 0) {
                            picked = options[Math.floor(Math.random() * options.length)];
                            dailyAssigned = true;
                        }
                    }

                    // Priority 4: Random Veg Fill
                    if (!picked) {
                        let options = pool.filter(d => d.category === 'Veg');
                        if (options.length === 0) options = master.filter(d => d.category === 'Veg');
                        picked = options[Math.floor(Math.random() * options.length)];
                    }

                    schedule[day][m] = picked.name;
                    if (picked.servings > 1) { leftover.item = picked; leftover.rem = picked.servings - 1; }
                    if (!picked.duplicateEnabled && !picked.isDailyDish) pool = pool.filter(p => p.name !== picked.name);
                }
            }
        }

        const b = db.batch();
        days.forEach(d => b.set(db.collection(collectionMealPlan).doc(d), schedule[d]));
        await b.commit();
        loadPlan();
    }
</script>
</body>
</html>